<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GramSahayak | Village Management Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #16a34a; /* Brighter green to match image */
            --primary-dark: #15803d;
            --sidebar: #111111;
        }
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .bg-primary { background-color: var(--primary); }
        .bg-primary-dark { background-color: var(--primary-dark); }
        .text-primary { color: var(--primary); }
        .sidebar-bg { background-color: var(--sidebar); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Hero Background with Gradient Overlay */
        .hero-bg {
            background-image: linear-gradient(90deg, #ffffff 0%, #ffffff 35%, rgba(255,255,255,0.9) 50%, rgba(255,255,255,0.4) 100%), url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=2500&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Soft Scroll padding for fixed header */
        html { scroll-padding-top: 80px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased">

    <div id="app" class="h-screen w-full overflow-hidden flex relative"></div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 animate-fade-in border-t-4 border-red-500">
            <h3 id="confirm-title" class="font-bold text-lg mb-2 text-gray-800">Confirm Action</h3>
            <p id="confirm-message" class="text-gray-600 mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-end gap-3">
                <button id="confirm-cancel" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition-colors">Cancel</button>
                <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium shadow-lg shadow-red-200 transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const USE_MOCK_DATA = false;  // SET TO FALSE FOR PRODUCTION
        const API_URL = './api.php'; 

        // --- APP STATE ---
        let state = {
            user: JSON.parse(localStorage.getItem('gs_user')) || null,
            view: 'landing', // 'landing', 'auth', 'dashboard'
            sidebarOpen: window.innerWidth > 768,
            activeTab: 'dashboard',
            isRegisterMode: false, 
            isAdminLogin: false
        };

        // --- API CALL (REAL FETCH) ---
        async function apiCall(action, method='GET', data={}) {
            if(USE_MOCK_DATA) {
                // Mock logic removed for brevity in this production version
                return {success: false, message: "Mock data disabled"};
            } else {
                try {
                    // Inject user ID/Name into data automatically if logged in
                    if(state.user) {
                        data.user_id = state.user.id;
                        data.user_name = state.user.name;
                    }
                    
                    const response = await fetch(`${API_URL}?action=${action}`, {
                        method: 'POST', // We use POST for almost everything to send JSON body
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    return result;
                } catch(e) {
                    console.error("API Error:", e);
                    return {success: false, message: "Server connection failed"};
                }
            }
        }

        // --- UTILITIES ---
        function showConfirm(title, msg, onConfirm) {
            const m = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerText = msg;
            m.classList.remove('hidden');
            const ok = document.getElementById('confirm-ok'), can = document.getElementById('confirm-cancel');
            const newOk = ok.cloneNode(true), newCan = can.cloneNode(true);
            ok.parentNode.replaceChild(newOk, ok); can.parentNode.replaceChild(newCan, can);
            newOk.addEventListener('click', ()=>{ onConfirm(true); m.classList.add('hidden'); });
            newCan.addEventListener('click', ()=>{ onConfirm(false); m.classList.add('hidden'); });
        }

        // --- NAVIGATION HELPERS ---
        function goHome() { state.view = 'landing'; render(); }
        function goLogin() { state.view = 'auth'; state.isRegisterMode = false; state.isAdminLogin = false; render(); }
        function goRegister() { state.view = 'auth'; state.isRegisterMode = true; state.isAdminLogin = false; render(); }

        // --- RENDER ENGINE ---
        const app = document.getElementById('app');

        function render() {
            app.innerHTML = '';
            if (state.user) {
                renderLayout();
            } else {
                if (state.view === 'auth') renderAuth();
                else renderLanding();
            }
        }

        // --- 1. LANDING PAGE VIEW (EXPANDED) ---
        function renderLanding() {
            app.innerHTML = `
                <div class="w-full h-full overflow-y-auto relative bg-white">
                    <nav class="fixed top-0 left-0 w-full z-50 flex items-center justify-between px-6 md:px-12 py-4 bg-white/90 backdrop-blur-md shadow-sm">
                        <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white"><i class="fas fa-seedling"></i></div>
                            <div class="text-2xl font-bold text-gray-800">GramSahayak</div>
                        </div>
                        <div class="hidden md:flex items-center gap-8 text-gray-600 font-medium">
                            <a href="#home" class="hover:text-primary transition-colors">Home</a>
                            <a href="#features" class="hover:text-primary transition-colors">Features</a>
                            <a href="#services" class="hover:text-primary transition-colors">Services</a>
                            <button onclick="goLogin()" class="bg-primary text-white px-6 py-2 rounded-full shadow-lg hover:bg-primary-dark transition-all transform hover:scale-105">Login</button>
                        </div>
                    </nav>

                    <div id="home" class="w-full min-h-screen hero-bg flex items-center px-6 md:px-16 relative">
                        <div class="w-full md:w-1/2 space-y-8 animate-fade-in pt-20 z-10">
                            <div class="inline-block bg-green-100 text-green-700 px-4 py-1 rounded-full text-sm font-bold tracking-wide">DIGITAL INDIA INITIATIVE</div>
                            <h1 class="text-5xl md:text-7xl font-bold text-gray-900 leading-tight">
                                Smart Village <br><span class="text-primary">Smart Governance</span>
                            </h1>
                            <p class="text-xl text-gray-600 leading-relaxed max-w-lg">
                                GramSahayak bridges the gap between villagers and administration. Apply for certificates, pay taxes, and voice your concerns from the comfort of your home.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                                <button onclick="goRegister()" class="bg-primary text-white px-8 py-4 rounded-full shadow-xl hover:bg-primary-dark hover:scale-105 transition-all flex items-center justify-center gap-2 font-bold text-lg">
                                    Join Your Village <i class="fas fa-arrow-right"></i>
                                </button>
                                <a href="#features" class="bg-white text-primary border-2 border-primary px-8 py-4 rounded-full hover:bg-green-50 transition-all font-bold text-lg shadow-sm flex items-center justify-center">
                                    Explore Features
                                </a>
                            </div>
                        </div>
                    </div>

                    <div id="features" class="py-20 px-6 md:px-16 bg-white">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div class="p-8 bg-green-50 rounded-2xl">
                                <div class="w-14 h-14 bg-green-100 text-green-600 rounded-xl flex items-center justify-center text-2xl mb-6"><i class="fas fa-file-signature"></i></div>
                                <h4 class="text-xl font-bold mb-3">Digital Certification</h4>
                                <p class="text-gray-600">Get birth, death, and residence certificates issued digitally.</p>
                            </div>
                            <div class="p-8 bg-blue-50 rounded-2xl">
                                <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-2xl mb-6"><i class="fas fa-bullhorn"></i></div>
                                <h4 class="text-xl font-bold mb-3">Direct Grievance</h4>
                                <p class="text-gray-600">Report issues like broken streetlights directly to the Sarpanch.</p>
                            </div>
                            <div class="p-8 bg-orange-50 rounded-2xl">
                                <div class="w-14 h-14 bg-orange-100 text-orange-600 rounded-xl flex items-center justify-center text-2xl mb-6"><i class="fas fa-hand-holding-heart"></i></div>
                                <h4 class="text-xl font-bold mb-3">Welfare Schemes</h4>
                                <p class="text-gray-600">Stay updated with the latest government schemes.</p>
                            </div>
                        </div>
                    </div>

                    <footer class="bg-gray-900 text-white py-12 px-6 md:px-16 text-center">
                        <p class="text-gray-400 text-sm">&copy; 2025 GramSahayak. All rights reserved.</p>
                    </footer>
                </div>
            `;
        }

        // --- 2. AUTH VIEW ---
        function renderAuth() {
            app.innerHTML = `
                <div class="w-full h-full flex items-center justify-center bg-gray-100 p-4 relative">
                    <button onclick="goHome()" class="absolute top-6 left-6 text-gray-500 hover:text-primary font-bold z-50 flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> Back to Home
                    </button>

                    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden animate-fade-in">
                        <div class="w-full md:w-1/2 bg-primary p-12 text-white flex flex-col justify-center relative">
                            <h1 class="text-5xl font-bold mb-4 relative z-10">GramSahayak</h1>
                            <p class="text-lg opacity-90 relative z-10">Empowering Villages through Digital Governance.</p>
                        </div>
                        <div class="w-full md:w-1/2 p-12 relative">
                            <div class="absolute top-4 right-4 flex gap-2">
                                <button onclick="state.isAdminLogin=false; state.isRegisterMode=false; render()" class="text-xs font-bold px-3 py-1 rounded-full transition-colors ${!state.isAdminLogin?'bg-primary text-white shadow-md':'bg-gray-100 text-gray-500 hover:bg-gray-200'}">User</button>
                                <button onclick="state.isAdminLogin=true; state.isRegisterMode=false; render()" class="text-xs font-bold px-3 py-1 rounded-full transition-colors ${state.isAdminLogin?'bg-primary text-white shadow-md':'bg-gray-100 text-gray-500 hover:bg-gray-200'}">Admin</button>
                            </div>
                            <h2 class="text-3xl font-bold mb-1 text-gray-800">${state.isRegisterMode?'Create Account':(state.isAdminLogin?'Admin Login':'Welcome Back')}</h2>
                            <p class="text-sm text-gray-500 mb-8">Please enter your details to continue</p>
                            
                            <form id="auth-form" class="space-y-4">
                                ${state.isRegisterMode ? `<div class="group"><label class="text-xs font-bold text-gray-500 uppercase">Full Name</label><input id="auth-name" class="w-full border-b-2 border-gray-200 p-2 focus:border-primary focus:outline-none transition-colors" placeholder="e.g. Rajesh Kumar" required></div>` : ''}
                                <div class="group">
                                    <label class="text-xs font-bold text-gray-500 uppercase">${state.isAdminLogin?'Username':'Email Address'}</label>
                                    <input id="auth-id" class="w-full border-b-2 border-gray-200 p-2 focus:border-primary focus:outline-none transition-colors" placeholder="${state.isAdminLogin?'admin':'user@gram.com'}" value="${!state.isRegisterMode && state.isAdminLogin?'admin':(!state.isRegisterMode?'user@gram.com':'')}" required>
                                </div>
                                <div class="group">
                                    <label class="text-xs font-bold text-gray-500 uppercase">Password</label>
                                    <input id="auth-pass" type="password" class="w-full border-b-2 border-gray-200 p-2 focus:border-primary focus:outline-none transition-colors" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="password" required>
                                </div>
                                <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-bold shadow-lg hover:bg-primary-dark transform active:scale-95 transition-all mt-4">${state.isRegisterMode?'Sign Up':'Login'}</button>
                            </form>
                            ${!state.isAdminLogin ? `<p class="mt-6 text-center text-sm text-gray-500">${state.isRegisterMode ? 'Already have an account?' : 'New to GramSahayak?'} <span class="cursor-pointer text-primary font-bold hover:underline" onclick="state.isRegisterMode=!state.isRegisterMode; render()">${state.isRegisterMode?'Login here':'Create Account'}</span></p>` : ''}
                        </div>
                    </div>
                </div>`;
            
            document.getElementById('auth-form').onsubmit = async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                const originalText = btn.innerText; btn.innerText = 'Processing...'; btn.disabled = true;
                const payload = { password: document.getElementById('auth-pass').value };
                const authId = document.getElementById('auth-id').value;

                if(state.isRegisterMode) { payload.name = document.getElementById('auth-name').value; payload.email = authId; } 
                else { payload.isAdmin = state.isAdminLogin; payload[state.isAdminLogin ? 'username' : 'email'] = authId; }

                const action = state.isRegisterMode ? 'register_user' : 'login';
                const res = await apiCall(action, 'POST', payload);
                
                if(res.success) { state.user = res.user; localStorage.setItem('gs_user', JSON.stringify(res.user)); render(); } 
                else { alert(res.message); btn.innerText = originalText; btn.disabled = false; }
            }
        }

        // --- 3. DASHBOARD LAYOUT ---
        function renderLayout() {
            const isAdmin = state.user.type === 'admin';
            const menu = isAdmin ? ['dashboard', 'users', 'services', 'meetings', 'reports', 'waste', 'queries', 'police', 'settings'] : ['dashboard', 'services', 'meetings', 'waste', 'work', 'queries', 'police', 'settings'];
            const labels = { dashboard: 'Dashboard', users: 'Manage Users', services: 'Services', meetings: 'Meetings', reports: 'Work Reports', waste: 'Waste Disposal', queries: 'Queries', police: 'Village Police', work: 'Village Work', settings: 'Settings' };
            const icons = { dashboard: 'fa-chart-pie', users: 'fa-users', services: 'fa-landmark', meetings: 'fa-handshake', reports: 'fa-clipboard-list', waste: 'fa-recycle', queries: 'fa-comments', police: 'fa-shield-alt', work: 'fa-hammer', settings: 'fa-cog' };

            app.innerHTML = `
                <div class="w-full h-full flex">
                    <aside class="w-64 h-full sidebar-bg text-white flex flex-col transition-all duration-300 ${state.sidebarOpen?'translate-x-0':'translate-x-[-100%] absolute z-20 h-full'} md:static md:translate-x-0 shadow-xl">
                        <div class="p-6 flex items-center gap-3 border-b border-gray-800">
                            <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center"><i class="fas fa-seedling text-white"></i></div>
                            <div class="font-bold text-xl tracking-wide">GramSahayak</div>
                        </div>
                        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                            ${menu.map(id => `<button onclick="state.activeTab='${id}'; render()" class="w-full text-left px-4 py-3 rounded-xl transition-all flex items-center gap-3 ${state.activeTab===id?'bg-primary text-white shadow-lg shadow-green-900/20':'text-gray-400 hover:bg-gray-800 hover:text-white'}"><div class="w-6 text-center"><i class="fas ${icons[id]}"></i></div><span class="font-medium">${labels[id]}</span></button>`).join('')}
                        </nav>
                        <button onclick="localStorage.removeItem('gs_user'); state.user=null; goHome()" class="p-4 m-4 bg-gray-800 rounded-xl text-red-400 hover:bg-red-900/20 hover:text-red-500 transition-colors flex items-center justify-center gap-2"><i class="fas fa-sign-out-alt"></i> Logout</button>
                    </aside>
                    <main class="flex-1 flex flex-col bg-gray-50 overflow-hidden relative">
                        <header class="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm z-10">
                            <div class="flex items-center gap-4">
                                <button class="md:hidden text-gray-600 text-xl" onclick="state.sidebarOpen=!state.sidebarOpen; document.querySelector('aside').classList.toggle('translate-x-[-100%]')"><i class="fas fa-bars"></i></button>
                                <h2 class="font-bold text-lg text-gray-800">${labels[state.activeTab]}</h2>
                            </div>
                            <div class="flex items-center gap-3 bg-gray-50 py-1 px-3 rounded-full border border-gray-200">
                                <div class="text-right hidden sm:block"><div class="font-bold text-sm text-gray-800">${state.user.name}</div><div class="text-xs text-primary font-medium uppercase tracking-wider">${state.user.type}</div></div>
                                <div class="w-9 h-9 bg-primary text-white rounded-full flex items-center justify-center shadow-md"><i class="fas fa-user"></i></div>
                            </div>
                        </header>
                        <div id="content" class="flex-1 overflow-y-auto p-4 md:p-8 animate-fade-in"></div>
                    </main>
                </div>`;
            renderContent();
        }

        async function renderContent() {
            const c = document.getElementById('content');
            c.innerHTML = `<div class="flex h-full items-center justify-center flex-col gap-3 text-gray-400"><i class="fas fa-circle-notch fa-spin text-4xl text-primary"></i><p>Loading Data...</p></div>`;
            const res = await apiCall('get_dashboard'); 
            const db = res.success ? res.data : {allUsers:[], services:[], meetings:[], workRequests:[], wasteRequests:[], queries:[], incidents:[], workReports: []}; 
            c.innerHTML = '';

            if(state.activeTab === 'dashboard') {
                if(state.user.type === 'admin') {
                    c.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            ${[{l:'Total Users',v:db.allUsers.length,c:'blue',i:'users'},{l:'Pending Queries',v:db.queries.filter(q=>q.status==='pending').length,c:'red',i:'exclamation-circle'},{l:'Waste Requests',v:db.wasteRequests.filter(w=>w.status==='Pending').length,c:'yellow',i:'trash'},{l:'Incidents',v:db.incidents.filter(i=>i.status==='Pending').length,c:'orange',i:'shield-alt'}].map(i=>`<div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-shadow"><div class="absolute right-0 top-0 w-24 h-24 bg-${i.c}-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div><div class="relative z-10"><div class="text-gray-500 text-sm font-medium uppercase mb-1">${i.l}</div><div class="text-4xl font-bold text-gray-800">${i.v}</div><div class="mt-4 text-${i.c}-600 text-sm font-medium"><i class="fas fa-${i.i} mr-1"></i> Update</div></div></div>`).join('')}
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6"><h3 class="font-bold text-lg mb-4">Recent Activity</h3><div class="space-y-4">${db.queries.slice(0,3).map(q=>`<div class="flex items-start gap-3 pb-3 border-b last:border-0 border-gray-100"><div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center shrink-0"><i class="fas fa-comment"></i></div><div><div class="text-sm font-bold text-gray-800">${q.user_name}</div><div class="text-xs text-gray-500">Query: ${q.subject}</div></div></div>`).join('')}</div></div></div>`;
                } else {
                    c.innerHTML = `
                        <div class="bg-gradient-to-r from-green-800 to-green-600 rounded-3xl p-8 text-white mb-8 shadow-lg relative overflow-hidden"><div class="relative z-10"><h2 class="text-3xl font-bold mb-2">Namaste, ${state.user.name.split(' ')[0]}! üôè</h2><p class="opacity-90">Welcome to your GramSahayak digital portal.</p></div><i class="fas fa-leaf absolute -bottom-4 -right-4 text-9xl opacity-20"></i></div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            ${[{l:'Upcoming Meetings',v:db.meetings.length,c:'blue',i:'calendar-alt'},{l:'My Applications',v:db.services.filter(s=>s.user_id==state.user.id).length,c:'purple',i:'file-alt'},{l:'Village Works',v:db.workReports.filter(w=>w.status!=='Completed').length,c:'yellow',i:'hard-hat'}].map(i=>`<div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:-translate-y-1 transition-transform duration-300"><div class="w-12 h-12 bg-${i.c}-50 rounded-xl flex items-center justify-center text-${i.c}-600 mb-4"><i class="fas fa-${i.i} text-xl"></i></div><div class="text-gray-500 text-sm font-medium">${i.l}</div><div class="text-3xl font-bold text-gray-800 mt-1">${i.v}</div></div>`).join('')}
                        </div>`;
                }
            }
            else if(state.activeTab === 'services') {
                if(state.user.type==='user') {
                    const serviceList = [{n:"Birth Certificate",i:"baby",c:"text-blue-600",b:"bg-blue-50"},{n:"Death Certificate",i:"book-medical",c:"text-gray-600",b:"bg-gray-100"},{n:"Residence Certificate",i:"house-user",c:"text-green-600",b:"bg-green-50"},{n:"Marriage Certificate",i:"ring",c:"text-pink-600",b:"bg-pink-50"},{n:"Property Tax",i:"building",c:"text-indigo-600",b:"bg-indigo-50"},{n:"Water Connection",i:"faucet",c:"text-cyan-600",b:"bg-cyan-50"},{n:"Electricity Connection",i:"bolt",c:"text-yellow-600",b:"bg-yellow-50"},{n:"Farmer Assistance",i:"tractor",c:"text-emerald-600",b:"bg-emerald-50"},{n:"Employment",i:"briefcase",c:"text-purple-600",b:"bg-purple-50"},{n:"Pension Scheme",i:"user-clock",c:"text-orange-600",b:"bg-orange-50"}];
                    c.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">${serviceList.map(s => `<div class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-100 transition-all hover:-translate-y-1" onclick="modal('app','${s.n}')"><div class="flex items-center gap-3 mb-2"><div class="w-10 h-10 rounded-full ${s.b} ${s.c} flex items-center justify-center"><i class="fas fa-${s.i}"></i></div><div class="font-bold leading-tight text-sm text-gray-700">${s.n}</div></div><div class="text-xs text-primary font-bold mt-2 flex items-center gap-1">Apply Now <i class="fas fa-arrow-right"></i></div></div>`).join('')}</div><h3 class="font-bold mb-4 text-lg text-gray-800 border-b pb-2">My Applications</h3><div class="space-y-3">${(db.services||[]).filter(s=>s.user_id==state.user.id).map(s=>`<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><div><div class="font-bold text-gray-800 flex items-center gap-2">${s.service_type}</div><div class="text-sm text-gray-500 mt-1">${s.details}</div>${s.document ? `<div class="text-xs text-blue-500 mt-2 bg-blue-50 inline-block px-2 py-1 rounded"><i class="fas fa-paperclip mr-1"></i> ${s.document}</div>` : ''}</div><span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${s.status==='Approved'?'bg-green-100 text-green-700':(s.status==='Rejected'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700')}">${s.status}</span></div>`).join('')}</div>`;
                } else {
                    c.innerHTML = `<h2 class="text-xl font-bold mb-4">Application Requests</h2><div class="space-y-3">${db.services.map(s=>`<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between gap-4"><div><div class="font-bold text-lg">${s.service_type}</div><div class="text-gray-600 text-sm">Applicant: <span class="font-semibold">${s.user_name}</span></div><div class="text-gray-500 text-sm mt-1">${s.details}</div></div><div class="flex items-center gap-2"><select onchange="apiCall('update_application_status','POST',{id:${s.id},status:this.value})" class="border rounded-lg px-3 py-2 text-sm"><option ${s.status==='Pending'?'selected':''}>Pending</option><option ${s.status==='Approved'?'selected':''}>Approved</option><option ${s.status==='Rejected'?'selected':''}>Rejected</option></select></div></div>`).join('')}</div>`;
                }
            }
            else if(state.activeTab === 'users') { c.innerHTML = `<h2 class="text-xl font-bold mb-4">Manage Citizens</h2><div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100"><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-50 border-b text-xs uppercase text-gray-500"><tr><th class="p-4">Name</th><th class="p-4">Email</th><th class="p-4">Action</th></tr></thead><tbody>${db.allUsers.map(u=>`<tr class="border-b hover:bg-gray-50"><td class="p-4 font-medium">${u.user_name}</td><td class="p-4 text-gray-600">${u.user_email}</td><td class="p-4"><button onclick="showConfirm('Delete User','Remove user?',async(ok)=>{if(ok){await apiCall('delete_user','POST',{id:${u.user_id}});renderContent()}})" class="text-red-500 p-2"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody></table></div></div>`; }
            else if(state.activeTab === 'waste') {
                if(state.user.type==='user') { c.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">Waste Collection</h2><button onclick="modal('waste')" class="bg-primary text-white px-4 py-2 rounded-lg shadow">Request Pickup</button></div><div class="grid gap-3">${db.wasteRequests.filter(r=>r.user_id==state.user.id).map(r=>`<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center"><div><div class="font-bold text-gray-800">${r.location}</div><div class="text-xs text-gray-500">${r.date}</div></div><div class="flex items-center gap-3"><span class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600">${r.status}</span>${r.status==='Pending'?`<button onclick="showConfirm('Cancel','Cancel?',async(ok)=>{if(ok){await apiCall('delete_waste','POST',{id:${r.id}});renderContent()}})" class="text-red-500 p-1"><i class="fas fa-times"></i></button>`:''}</div></div>`).join('')}</div>`; }
                else { c.innerHTML = `<h2 class="text-xl font-bold mb-4">Waste Queue</h2><div class="space-y-2">${db.wasteRequests.map(r=>`<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center"><div><div class="font-bold text-gray-800">${r.user_name}</div><div class="text-sm text-gray-600">${r.location}</div></div><div class="flex gap-2"><select onchange="apiCall('update_waste_status','POST',{id:${r.id},status:this.value});" class="border rounded p-1 text-sm"><option ${r.status==='Pending'?'selected':''}>Pending</option><option ${r.status==='Completed'?'selected':''}>Completed</option></select></div></div>`).join('')}</div>`; }
            }
            else if(state.activeTab === 'meetings') { c.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">Meetings</h2>${state.user.type==='admin'?`<button onclick="modal('meet')" class="bg-primary text-white px-4 py-2 rounded-lg shadow">Schedule</button>`:''}</div><div class="grid gap-4 md:grid-cols-2">${db.meetings.map(m=>`<div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-primary flex justify-between"><div><div class="font-bold text-lg text-gray-800">${m.purpose}</div><div class="text-sm text-gray-500">${m.date} | ${m.time}</div><div class="text-sm text-gray-500">${m.location}</div></div>${state.user.type==='admin'?`<div><button onclick="showConfirm('Delete','Cancel?',async(ok)=>{if(ok){await apiCall('delete_meeting','POST',{id:${m.id}});renderContent()}})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button></div>`:''}</div>`).join('')}</div>`; }
            else if(state.activeTab === 'work') { c.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">Works</h2>${state.user.type==='admin'?`<button onclick="modal('work')" class="bg-primary text-white px-4 py-2 rounded-lg shadow">Add Report</button>`:''}</div><div class="grid gap-4">${db.workReports.map(w=>`<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center"><div><div class="font-bold text-lg text-gray-800">${w.title}</div><div class="text-xs text-gray-400 uppercase mt-1">${w.date}</div></div><div class="flex items-center gap-4"><span class="px-3 py-1 rounded-full text-xs font-bold ${w.status==='Completed'?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700'}">${w.status}</span>${state.user.type==='admin'?`<button onclick="showConfirm('Delete','Remove?',async(ok)=>{if(ok){await apiCall('delete_work','POST',{id:${w.id}});renderContent()}})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>`:''}</div></div>`).join('')}</div>`; }
            else if(state.activeTab === 'queries') { if(state.user.type==='user'){ c.innerHTML=`<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8"><h3 class="font-bold mb-4">Submit Query</h3><div class="flex gap-3"><input id="q-sub" class="border p-3 rounded-lg w-1/3" placeholder="Subject"><input id="q-msg" class="border p-3 rounded-lg w-2/3" placeholder="Message"><button onclick="subQuery()" class="bg-primary text-white px-6 py-3 rounded-lg">Send</button></div></div><h3 class="font-bold mb-4">History</h3><div class="space-y-3">${db.queries.filter(q=>q.user_id==state.user.id).map(q=>`<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><div><span class="font-bold">${q.subject}</span> | ${q.message}</div><span class="text-xs font-bold px-2 py-1 rounded ${q.status==='resolved'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${q.status}</span></div>`).join('')}</div>`; } else { c.innerHTML=`<h2 class="text-xl font-bold mb-4">Queries</h2><div class="space-y-3">${db.queries.map(q=>`<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex justify-between"><div><div class="font-bold">${q.user_name}</div><div class="text-primary font-semibold">${q.subject}</div><div>${q.message}</div></div><select onchange="apiCall('update_query_status','POST',{id:${q.id},status:this.value})" class="border rounded-lg p-2"><option ${q.status==='pending'?'selected':''}>pending</option><option ${q.status==='resolved'?'selected':''}>resolved</option></select></div>`).join('')}</div>`; } }
            else if(state.activeTab === 'police') { if(state.user.type==='user'){ c.innerHTML=`<div class="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-lg border-t-4 border-red-600"><h2 class="text-2xl font-bold text-red-600 mb-4">Report Incident</h2><select id="p-type" class="w-full border bg-gray-50 p-3 mb-4 rounded-lg"><option>Theft</option><option>Violence</option><option>Other</option></select><input id="p-loc" class="w-full border bg-gray-50 p-3 mb-4 rounded-lg" placeholder="Location"><textarea id="p-det" class="w-full border bg-gray-50 p-3 mb-4 rounded-lg h-24" placeholder="Details"></textarea><label class="flex items-center gap-2 mb-6"><input type="checkbox" id="p-anon"> Anonymous</label><button onclick="subPol()" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold">Submit</button></div>`; } else { c.innerHTML=`<h2 class="text-xl font-bold mb-4">Incidents</h2><div class="space-y-3">${db.incidents.map(i=>`<div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-500 flex justify-between"><div><div class="text-red-600 font-bold">${i.incident_type}</div><div>${i.location}</div><div>${i.details}</div></div><select onchange="apiCall('update_incident_status','POST',{id:${i.id},status:this.value})" class="border rounded-lg"><option ${i.status==='Pending'?'selected':''}>Pending</option><option ${i.status==='Resolved'?'selected':''}>Resolved</option></select></div>`).join('')}</div>`; } }
            else if(state.activeTab === 'settings') { c.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 max-w-2xl"><h2 class="text-2xl font-bold mb-6">Settings</h2><div class="space-y-6"><div class="flex justify-between items-center border-b pb-4"><div><div class="font-bold">Notifications</div></div><input type="checkbox" checked></div><div class="flex justify-between items-center border-b pb-4"><div><div class="font-bold">Dark Mode</div></div><input type="checkbox"></div><button class="bg-gray-800 text-white px-6 py-2 rounded-lg">Save</button></div></div>`; }
        }

        // --- MODAL LOGIC ---
        function modal(type, extra) {
            const d = document.createElement('div'); d.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm p-4";
            let title = type === 'app' ? `Apply: ${extra}` : (type === 'waste' ? 'Request Pickup' : (type === 'meet' ? 'Schedule' : 'Add Work'));
            let html = `<div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl animate-fade-in"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-xl text-gray-800">${title}</h3><button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div>`;
            if(type==='waste') html+=`<label class="block text-sm font-bold mb-1">Location</label><input id="m-loc" class="w-full border p-3 rounded-lg mb-6 bg-gray-50" placeholder="Address"><button id="m-sub" class="w-full bg-primary text-white py-3 rounded-lg font-bold">Submit</button>`;
            else if(type==='work') html+=`<label class="block text-sm font-bold mb-1">Title</label><input id="m-ti" class="w-full border p-3 rounded-lg mb-4 bg-gray-50"><label class="block text-sm font-bold mb-1">Status</label><select id="m-st" class="w-full border p-3 rounded-lg mb-6 bg-gray-50"><option>Planned</option><option>In Progress</option></select><button id="m-sub" class="w-full bg-primary text-white py-3 rounded-lg font-bold">Save</button>`;
            else if(type==='meet') html+=`<label class="block text-sm font-bold mb-1">Location</label><input id="m-loc" class="w-full border p-3 rounded-lg mb-3 bg-gray-50"><label class="block text-sm font-bold mb-1">Purpose</label><input id="m-pur" class="w-full border p-3 rounded-lg mb-3 bg-gray-50"><div class="flex gap-3 mb-6"><div class="w-1/2"><label class="block text-sm font-bold mb-1">Date</label><input type="date" id="m-date" class="w-full border p-3 rounded-lg bg-gray-50"></div><div class="w-1/2"><label class="block text-sm font-bold mb-1">Time</label><input type="time" id="m-time" class="w-full border p-3 rounded-lg bg-gray-50"></div></div><button id="m-sub" class="w-full bg-primary text-white py-3 rounded-lg font-bold">Schedule</button>`;
            else if(type==='app') html+=`<div class="bg-blue-50 p-4 rounded-lg mb-4 text-sm text-blue-800">Applying for <b>${extra}</b></div><label class="block text-sm font-bold mb-1 text-gray-700">Details</label><textarea id="m-det" class="w-full border p-3 rounded-lg mb-4 bg-gray-50 h-24"></textarea><label class="block text-sm font-bold mb-1 text-gray-700">Document</label><input type="file" id="m-file" class="w-full mb-6"><button id="m-sub" class="w-full bg-primary text-white py-3 rounded-lg font-bold">Submit</button>`;
            html += `</div>`; d.innerHTML=html; document.body.appendChild(d);
            document.getElementById('m-sub').onclick = async () => {
                const btn = document.getElementById('m-sub'); btn.innerText = 'Saving...'; btn.disabled = true;
                if(type==='waste') await apiCall('add_waste','POST',{location:document.getElementById('m-loc').value});
                if(type==='work') await apiCall('add_work','POST',{title:document.getElementById('m-ti').value, status:document.getElementById('m-st').value});
                if(type==='meet') await apiCall('add_meeting','POST',{location:document.getElementById('m-loc').value, purpose:document.getElementById('m-pur').value, date:document.getElementById('m-date').value, time:document.getElementById('m-time').value});
                if(type==='app') { const f = document.getElementById('m-file').files[0]; await apiCall('submit_application','POST',{service_type: extra, details: document.getElementById('m-det').value, documentName: f ? f.name : ''}); }
                d.remove(); renderContent();
            }
        }

        async function subQuery() { const sub = document.getElementById('q-sub').value, msg = document.getElementById('q-msg').value; if(!sub || !msg) return alert("Fill fields"); await apiCall('submit_query','POST',{subject:sub, message:msg}); renderContent(); }
        async function subPol() { const type = document.getElementById('p-type').value, loc = document.getElementById('p-loc').value, det = document.getElementById('p-det').value; if(!loc || !det) return alert("Fill fields"); await apiCall('submit_incident','POST',{incident_type:type, location:loc, details:det, anonymous:document.getElementById('p-anon').checked}); showConfirm('Success', 'Reported.', ()=>renderContent()); }

        render();
    </script>
</body>
</html>